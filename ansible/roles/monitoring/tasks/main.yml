# Install Docker and Docker Compose
- name: Install Docker
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
  loop:
    - docker.io
    - docker-compose

- name: Ensure Docker service is running
  service:
    name: docker
    state: started
    enabled: yes

# Create Prometheus config
- name: Create Prometheus config
  copy:
    dest: /home/ubuntu/prometheus.yml
    content: |
      global:
        scrape_interval: 15s

      scrape_configs:
        - job_name: 'webserver'
          static_configs:
            - targets: ['10.0.0.5:9100']

# Create Docker Compose for Prometheus + Grafana
- name: Create Docker Compose File
  copy:
    dest: /home/ubuntu/monitoring-docker-compose.yml
    content: |
      version: '3'
      services:
        prometheus:
          image: prom/prometheus
          volumes:
            - ./prometheus.yml:/etc/prometheus/prometheus.yml
          ports:
            - "9090:9090"
        grafana:
          image: grafana/grafana
          ports:
            - "3000:3000"

# Run Monitoring Stack
- name: Start Monitoring Stack
  command: docker-compose -f /home/ubuntu/monitoring-docker-compose.yml up -d

# Cloudflare Tunnel guidance (manual step for private server)
- name: Cloudflare Tunnel Reminder
  debug:
    msg: "Please install cloudflared on monitoring server and create a tunnel for monitoring.frdamirul.com"
